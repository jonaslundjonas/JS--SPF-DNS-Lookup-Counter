<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width" />
  <title>SPF DNS Lookup Counter (Exceeding 10)</title>
  <!-- Materialize CSS -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    rel="stylesheet"
  />
  <!-- Material Icons -->
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      flex: 1;
      padding: 20px;
      max-width: 800px;
    }
    .card {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 20px;
    }
    .input-field input {
      color: #ffffff !important;
      border-bottom: 1px solid #555 !important;
    }
    .input-field input:focus {
      border-bottom: 1px solid #26a69a !important;
      box-shadow: 0 1px 0 0 #26a69a !important;
    }
    .input-field label {
      color: #888 !important;
    }
    .input-field input:focus + label {
      color: #26a69a !important;
    }
    .btn {
      background-color: #26a69a;
      text-transform: uppercase;
      font-family: 'Roboto', sans-serif;
      letter-spacing: 1px;
    }
    .btn:hover {
      background-color: #2bbbad;
    }
    .lookup-item {
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      background-color: #2d2d2d;
    }
    .lookup-count {
      display: inline-block;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      border-radius: 50%;
      margin-left: 10px;
      font-weight: bold;
    }
    .count-ok {
      background-color: #4caf50; /* green */
    }
    .count-warning {
      background-color: #ffa726; /* orange */
    }
    .count-error {
      background-color: #ef5350; /* red */
    }
    .count-exceed {
      background-color: #d32f2f; /* deeper red */
    }
  </style>
</head>
<body>
  <!-- Simple alert to confirm script is running -->
  <script>
    alert("Script is running!");
    console.log("JS loaded successfully.");
  </script>

  <div class="container">
    <h4 class="center-align">SPF DNS Lookup Counter (Exceeding 10)</h4>
    <p class="center-align" style="color: #888;">
      Enter a domain name to check its SPF record(s). This tool will
      <strong>continue enumerating beyond 10 lookups</strong> so you can see all references.
      Standard SPF practice typically stops at 10, but here we show them all anyway.
    </p>

    <div class="card">
      <div class="input-field">
        <input type="text" id="domainInput" class="validate" />
        <label for="domainInput">Enter Domain</label>
      </div>
      <div class="center-align">
        <button class="btn waves-effect waves-light" onclick="checkSPF()">
          <span class="valign-wrapper">
            CHECK SPF
            <i class="material-icons right">search</i>
          </span>
        </button>
      </div>
      <div id="results" class="section">
        <!-- Results will be displayed here -->
      </div>
    </div>
  </div>

  <footer
    class="center-align"
    style="padding: 20px; color: #666; font-size: 0.9em;"
  >
    Written by Jonas Lund 2024
  </footer>

  <!-- Materialize JS -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"
  ></script>
  <script>
    /**
     * Resolve DNS TXT records for a given domain via DNS over HTTPS API.
     * Using 1.1.1.1 to avoid potential Cloudflare blocks. If this doesn't work,
     * try "https://cloudflare-dns.com/dns-query" or another DoH provider.
     */
    async function resolveDNS(domain) {
      console.log("DEBUG: resolveDNS() called for domain:", domain);
      try {
        // Could also try: https://cloudflare-dns.com/dns-query
        const response = await fetch(
          `https://1.1.1.1/dns-query?name=${domain}&type=TXT`,
          {
            headers: { accept: 'application/dns-json' },
            mode: 'cors'
          }
        );
        console.log("DEBUG: fetch() response status:", response.status);

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const jsonData = await response.json();
        console.log("DEBUG: DNS response data:", jsonData);
        return jsonData;
      } catch (error) {
        console.error('DNS lookup error:', error);
        throw new Error(`Failed to resolve DNS for ${domain}: ${error.message}`);
      }
    }

    /**
     * Recursively check SPF for the given domain, respecting includes and redirects.
     * Does NOT stop at 10 lookups; it keeps going so you can see everything beyond.
     */
    async function checkDomainSPF(domain, level, lookups, visited) {
      console.log(`DEBUG: checkDomainSPF(${domain}, level=${level})`);

      // Prevent infinite loops if domain references itself.
      if (visited.has(domain)) {
        console.log("DEBUG: Domain already visited:", domain);
        return;
      }
      visited.add(domain);

      let dnsResponse;
      try {
        dnsResponse = await resolveDNS(domain);
      } catch (error) {
        console.error(`Error checking SPF for ${domain}:`, error);
        lookups.push({
          domain,
          level,
          record: `Error: ${error.message}`,
          type: 'TXT'
        });
        return;
      }

      // If no TXT answers are found, record it.
      if (!dnsResponse.Answer) {
        console.log("DEBUG: No TXT found for domain:", domain);
        lookups.push({
          domain,
          level,
          record: 'No TXT records found',
          type: 'TXT'
        });
        return;
      }

      // Filter out all TXT records that contain 'v=spf1'
      const spfRecords = dnsResponse.Answer.filter(ans =>
        ans.data.includes('v=spf1')
      );

      // If no SPF record found, add a note
      if (!spfRecords.length) {
        console.log("DEBUG: No SPF record found in the TXT for domain:", domain);
        lookups.push({
          domain,
          level,
          record: 'No SPF record found',
          type: 'TXT'
        });
        return;
      }

      // Process each SPF record
      for (const spfRecord of spfRecords) {
        lookups.push({
          domain,
          level,
          record: spfRecord.data,
          type: 'TXT'
        });

        // Extract includes (e.g. "include:some.domain.com")
        const includes = spfRecord.data.match(/include:([^\s]+)/g) || [];

        // Extract redirect (e.g. "redirect=_spf.google.com")
        const redirectMatch = spfRecord.data.match(/redirect=([^\s]+)/);

        // Recursively process each "include"
        for (const inc of includes) {
          const includedDomain = inc.split(':')[1];
          console.log(`DEBUG: Found include domain=${includedDomain} from ${domain}`);
          await checkDomainSPF(includedDomain, level + 1, lookups, visited);
        }

        // If there's a redirect domain, also recurse
        if (redirectMatch) {
          const redirectDomain = redirectMatch[1];
          console.log(`DEBUG: Found redirect domain=${redirectDomain} from ${domain}`);
          await checkDomainSPF(redirectDomain, level + 1, lookups, visited);
        }
      }
    }

    /**
     * Main function called when the user clicks "CHECK SPF".
     * Clears results area, performs the DNS lookups, and renders the output.
     */
    async function checkSPF() {
      console.log("DEBUG: checkSPF() called");
      const domain = document.getElementById('domainInput').value.trim();
      if (!domain) {
        M.toast({ html: 'Please enter a domain', classes: 'red' });
        console.log("DEBUG: No domain provided.");
        return;
      }

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML =
        '<div class="progress"><div class="indeterminate"></div></div>';

      try {
        const lookups = [];
        const visited = new Set();
        // Start at level 1
        await checkDomainSPF(domain, 1, lookups, visited);
        displayResults(lookups);
      } catch (error) {
        console.error("DEBUG: checkSPF() top-level error:", error);
        resultsDiv.innerHTML = `<div class="red-text">${error.message}</div>`;
        M.toast({ html: error.message, classes: 'red' });
      }
    }

    /**
     * Renders the SPF lookup results on the page.
     * We do not stop at 10; we highlight items > 10 differently.
     */
    function displayResults(lookups) {
      console.log("DEBUG: displayResults() called with lookups:", lookups);
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      lookups.forEach((lookup, index) => {
        const lookupDiv = document.createElement('div');
        lookupDiv.className = 'lookup-item';

        // The 1-based index of the lookup
        const itemNumber = index + 1;

        // Decide a style class for the count bubble
        let countClass = '';
        if (itemNumber <= 5) {
          countClass = 'count-ok';
        } else if (itemNumber <= 8) {
          countClass = 'count-warning';
        } else if (itemNumber <= 10) {
          countClass = 'count-error';
        } else {
          // If it's beyond 10, highlight it differently
          countClass = 'count-exceed';
        }

        // Remove any extra quotes from the record data for readability
        const recordText = lookup.record.replace(/"/g, '');

        lookupDiv.innerHTML = `
          <div>
            Level ${lookup.level}: ${lookup.domain}
            <span class="lookup-count ${countClass}">${itemNumber}</span>
          </div>
          <div style="margin-top: 5px; font-size: 0.9em; color: #888;">
            ${recordText}
          </div>
        `;
        resultsDiv.appendChild(lookupDiv);
      });

      // Show a summary
      const totalCount = lookups.length;
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'section center-align';

      // If totalCount <= 10, we show it in green, else red
      const countColorClass = totalCount <= 10 ? 'green-text' : 'red-text';
      summaryDiv.innerHTML = `
        <h5>Total DNS Lookups: 
          <span class="${countColorClass}">
            ${totalCount}/10 
            ${totalCount > 10 ? '(exceeding typical SPF limit!)' : ''}
          </span>
        </h5>
      `;
      resultsDiv.appendChild(summaryDiv);
    }

    // Initialize Materialize form elements
    document.addEventListener('DOMContentLoaded', function () {
      console.log("DEBUG: DOMContentLoaded event fired");
      M.updateTextFields();
    });
  </script>
</body>
</html>

